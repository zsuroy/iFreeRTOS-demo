# åŸºäºŽ STM32CubeMX + STM32CubeIDE çš„ FreeRTOS ç§»æ¤æ¨¡ç‰ˆ

> è®°å½• FreeRTOS å­¦ä¹ æ—¥å¿—åŠå¤‡ä»½é¡¹ç›®å·¥ç¨‹æ¨¡ç‰ˆ


## å¼€å‘çŽ¯å¢ƒ

+ FreeRTOS: V10.0
+ IDE: STM32CUBEIDE
+ MCU: STM32F103C8T6
+ å·¥ç¨‹æ¨¡ç‰ˆ: STM32CubeMX ç”Ÿæˆ FreeRTOS å·¥ç¨‹

## åŠŸèƒ½è¯´æ˜Ž

ä¸¤ä¸ªTaskä»»åŠ¡ï¼Œå®žçŽ°ç‚¹äº®é¢‘é—ªLEDç¯ï½ž


## ç§»æ¤è¯´æ˜Ž

> å·²ç»ç§»æ¤ä¸Šæœºæµ‹è¯•è¿‡äº†ï¼Œç›´æŽ¥ç¼–è¯‘è¿è¡Œå³å¯ã€‚  
> æœ¬æ–‡ä»…è®°å½•ä¸€ä¸‹å…³é”®æ­¥éª¤ï¼Œè¯¦ç»†ç§»æ¤å¯ä»¥çœ‹  
> [ä½¿ç”¨STM32CubeIDE è¿›è¡Œ FreeRTOS æ‰‹åŠ¨ç§»æ¤F103ç³»åˆ—æœ€å°ç³»ç»Ÿ](https://suroy.cn/embeded/use-stmcubeide-for-freertos-manual-migration-of-f103-series-minimum-system.html)  
> [è®°åŸºäºŽSTM32 çš„ FreeRTOS å­¦ä¹ çš„ç§»æ¤æ—¥å¿—](https://suroy.cn/embeded/record-the-migration-log-of-freertos-learning-based-on-stm32.html)

## ç‰ˆæœ¬æ—¥å¿—

### V1.0.0 2023.2.8

+ Task1ã€Task2åŒä¼˜å…ˆçº§æ¨¡æ‹Ÿå»¶æ—¶æµ‹è¯•
  + æµ‹è¯•ç›¸å¯¹å»¶æ—¶å’Œç»å¯¹å»¶æ—¶æ•ˆæžœ  
  + å·²ç»é…ç½® printf ä¸²å£é‡å®šå‘
  + é…ç½® PC13 LEDé—ªçƒ


### V1.0.1 2023.2.9

+ æŒ‰é”®æŽ§åˆ¶ä»»åŠ¡åˆ›å»º/åˆ é™¤ - çŸ­æŒ‰
+ æŒ‰é”®æŽ§åˆ¶ä»»åŠ¡æŒ‚èµ·/æ¢å¤ - é•¿æŒ‰
+ æŒ‰é”®å¼•è„š PA0
+ ä»»åŠ¡ä¸­æ‰“å°è¾“å‡ºä¼ å…¥å‚æ•°

æ³¨æ„ï¼š 
+ æ£€æµ‹æŒ‰é”®è¾“å…¥çš„æ—¶å€™ä¸€èˆ¬é‡‡ç”¨ä¸Šæ‹‰ï¼›å»¶æ—¶æ¶ˆæŠ–åŠ¨å®žæµ‹å–10msæ›´ä½³
+ æœ¬ä¾‹ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªæ¿è½½æŒ‰é”®å®žçŽ°çš„é•¿æŒ‰/çŸ­æŒ‰åŠŸèƒ½ï¼Œä¸å»ºè®®è¿™æ ·ä½¿ç”¨ï¼Œå¯èƒ½ä¼šå‡ºçŽ°å¼‚å¸¸ã€‚


#### å·²çŸ¥é—®é¢˜ï¼š ä»»åŠ¡2è¾“å‡ºæŒ‰ä»¥ä¸‹æ–¹å¼ä¼šå¡åœ¨ä»»åŠ¡2ä¸­ï¼Œå¯¼è‡´ä»»åŠ¡1æ— æ³•æ‰§è¡Œæˆ–è€…ä»…æ‰§è¡Œç¬¬ä¸€æ¬¡

```c
// ä»»åŠ¡2
void LedTaskCo(void const * argument)
{
  /* USER CODE BEGIN LedTaskCo */
  TickType_t xLastWakeTime;
  xLastWakeTime = xTaskGetTickCount();
  /* Infinite loop */
  for(;;)
  {
	  printf(argument);
	  printf("Task2: "); //ä¸è¦è¿™å¥ï¼Œæ‰å¯ä»¥è·‘
	  printf("\r\n");
	  osDelay(200); // æ¨¡æ‹Ÿä»»åŠ¡å ç”¨æ—¶é—´
	  vTaskDelayUntil(&xLastWakeTime,500); //ç»å¯¹å»¶æ—¶500ms
  }
  /* USER CODE END LedTaskCo */
}
```

çŽ„å­¦ï¼ŒåŽ»æŽ‰ç¬¬äºŒä¸ªprintfå¯ä»¥è¿è¡Œï¼›è‹¥æ”¹ç”¨å®Œå…¨ä¸€è‡´çš„ç¨‹åºæ•ˆæžœæ­£å¸¸ã€‚
é—®é¢˜åº”è¯¥æ˜¯å‡ºåœ¨ä¸¤ä¸ªä»»åŠ¡è°ƒç”¨çš„åŠŸèƒ½ã€æ‰€è€—æ—¶é—´ä¸åŒå¯¼è‡´æ—¶é—´ç‰‡è½®è½¬æ—¶äº§ç”Ÿçš„task1çš„printfæ²¡æœ‰æ¥å¾—åŠè¾“å‡ºæ‰€è‡´ã€‚

è§£å†³ï¼š `printf("Task2: %s\n\n", (char *)argument); //ä¼ å…¥NULLæ—¶ä¼šå¤§é‡è¾“å‡ºä¹±ç `

æ­£è§£ï¼š åœ¨ä»»åŠ¡ä¸­å¢žåŠ äº’æ–¥é‡è¿›è¡Œ printf å‡½æ•°çš„æŽ§åˆ¶


### V1.0.2 2023.2.10

+ é˜Ÿåˆ—çš„åŸºæœ¬ä½¿ç”¨
  + æ¶ˆæ¯é˜Ÿåˆ—(ä½¿ç”¨CubeMXåˆ›å»º)
  + æŒ‰é”®å‘é€ä»»åŠ¡: è®¾ç½®ç­‰å¾…æ—¶é—´ä¸º0
  + ä¸€ä¸ªæŽ¥æ”¶ä»»åŠ¡: ç­‰å¾…æ—¶é—´ä¸ºæœ€å¤§(portMAX_DELAY)

+ ä¿®å¤BUG
  + ä¿®æ”¹ä¹‹å‰ç‰ˆæœ¬çš„æŒ‰é”®æ£€æµ‹ä¸ºLED


### V1.0.3 2023.2.10

åˆ›å»ºä¿¡å·é‡: STM32CubeMXåˆ›å»ºé»˜è®¤ä¸º1; æ‰‹åŠ¨åˆ›å»ºä¸º0

1. FreeRTOS -> Timers and Semaphores -> Binary Semaphores

2. Add

æ‰‹åŠ¨åˆ›å»º:

```c
SemaphoreHandle_t BinarySem_Handle =NULL;
/* åˆ›å»º BinarySem */
BinarySem_Handle = xSemaphoreCreateBinary();
```

+ äºŒå€¼ä¿¡å·é‡
  + ä¸Šæœºä¼šè‡ªåŠ¨Take 1æ¬¡ä¿¡å·ï¼Œç”±äºŽCubeMXåˆå§‹åŒ–äºŒå€¼ä¿¡å·é‡ä¸ºæœ€å¤§å€¼1
  + æŒ‰é”®æŒ‰ä¸‹Giveä¿¡å·
  + Task2å®šæ—¶1sè´Ÿè´£Takeä¿¡å·


### V1.0.4 2023.2.10


+ ä¿®å¤BUG
  + V1.0.3 æ‰‹åŠ¨åˆ›å»ºäºŒå€¼ä¿¡å·é‡çš„é”™è¯¯

+ è®¡æ•°ä¿¡å·é‡

> æ¨¡æ‹Ÿè½¦åº“åœè½¦

åˆ›å»ºä¿¡å·é‡: STM32CubeMXåˆ›å»ºé»˜è®¤ä¸ºæœ€å¤§å€¼; æ‰‹åŠ¨åˆ›å»ºä¸º0
1. FreeRTOS -> Config Parameters -> USE_COUNTING_SEMAPHORES [enable]
2. FreeRTOS -> Timers and Semaphores -> Counting Semaphores
3. Add


æˆ–æ‰‹åŠ¨åˆ›å»º: 

```c
SemaphoreHandle_t CountSem_Handle =NULL;
/* åˆ›å»º CountSem */
CountSem_Handle = xSemaphoreCreateCounting(5,5); // MAX_Value, INIT_Value
```

+ ä»»åŠ¡: åˆ›å»ºè®¡æ•°ä¿¡å·é‡å¤§å°ä¸º2 
  + Task3: (æŒ‰é”®)å¯ä»¥å°†è½¦åœå…¥è½¦åº“/å¼€å‡ºè½¦åº“
  + Task2: ä¸²å£æ¯1ç§’æ˜¾ç¤ºä¸€ä¸‹è½¦åº“å†…è½¦è¾†æ•°æ®

### V1.0.5 2023.2.11

+ äº’æ–¥é‡å¼•å…¥

+ ä»»åŠ¡: æ¨¡æ‹Ÿä¼˜å…ˆçº§ç¿»è½¬
  > Task1ã€3æ‰€è®¿é—®çš„ä¸ºåŒä¸€äºŒå€¼ä¿¡å·é‡
  + Task1: é«˜ä¼˜å…ˆçº§ï¼ˆäºŒå€¼ä¿¡å·é‡ï¼‰
  + Task2: ä¸­ä¼˜å…ˆçº§ï¼ˆæ¨¡æ‹Ÿä»»åŠ¡å¹²æ‰°ï¼‰
  + Task3: ä½Žä¼˜å…ˆçº§ (äºŒå€¼ä¿¡å·é‡)

+ ç»“æžœ:
  å½“ä¸Šç”µ**å¼€æœº**ä¹‹åŽï¼Œ**ç³»ç»Ÿä¼šè°ƒç”¨ä¸€æ¬¡æœ€é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡**ï¼Œæ˜¯ç”±äºŽCubeMXåœ¨ç”ŸæˆäºŒå€¼ä¿¡å·é‡æ—¶ç»™çš„åˆå€¼ä¸º1(å³å·²ç»é‡Šæ”¾äºŒå€¼ä¿¡å·é‡)ï¼Œæ­¤æ—¶ä»»åŠ¡1å¯ä»¥èŽ·å–è¯¥ä¿¡å·é‡(åŒæ—¶èŽ·å–ä¹‹åŽä¿¡å·é‡å‡1ä¸º0)ï¼›**ä¹‹åŽçš„Task1é«˜ä¼˜å…ˆçº§ä»»åŠ¡å‡ä¼šç­‰å¾… Task2 å’Œ Task3 æ‰§è¡Œä¹‹åŽæ‰ä¼šä»Žé˜»å¡žè¿›å…¥å°±ç»ªåˆ°è¿è¡ŒçŠ¶æ€**ã€‚(PS: å¯ä»¥é˜…è¯»åšæ–‡è¯¦ç»†åˆ†æž)


### V1.0.6 2023.2.11

+ ä»»åŠ¡: äº’æ–¥é‡çš„ä¼˜å…ˆçº§ç»§æ‰¿
  > Task1ã€3æ‰€è®¿é—®çš„ä¸ºåŒä¸€äº’æ–¥é‡ï¼Œä¿®æ”¹è‡ªV1.0.5
  + Task1: é«˜ä¼˜å…ˆçº§ï¼ˆäºŒå€¼ä¿¡å·é‡ï¼‰
  + Task2: ä¸­ä¼˜å…ˆçº§ï¼ˆæ¨¡æ‹Ÿä»»åŠ¡å¹²æ‰°ï¼‰
  + Task3: ä½Žä¼˜å…ˆçº§ (äºŒå€¼ä¿¡å·é‡)

å®žéªŒç»“æžœ
    å½“ä¸Šç”µ**å¼€æœº**ä¹‹åŽï¼Œ**ç³»ç»Ÿä¼šä¾æ¬¡ä»Žé«˜åˆ°ä½Žè°ƒç”¨å„ä¼˜å…ˆçº§çš„ä»»åŠ¡**ï¼Œæ˜¯ç”±äºŽCubeMXåœ¨ç”Ÿæˆäº’æ–¥é‡æ—¶ç»™çš„åˆå€¼ä¸º1(å³å·²ç»é‡Šæ”¾äº’æ–¥é‡)ã€‚æœ€åŽä»Žæ­¤**Task1é«˜ä¼˜å…ˆçº§ä»»åŠ¡å‡ä¼šé˜»å¡žç­‰å¾…äº’æ–¥é‡é‡Šæ”¾ï¼ŒåŒæ—¶å°† ä½Žä¼˜å…ˆçº§ä»»åŠ¡Task3æåˆ°åŒçº§(å³é«˜ä¼˜å…ˆçº§)ï¼Œå¾…Task3æ‰§è¡Œä¹‹åŽæ‰ä¼šä»Žé˜»å¡žè¿›å…¥å°±ç»ªåˆ°è¿è¡ŒçŠ¶æ€ï¼Œæ–¹è¿è¡ŒTask2 ä¸­ä¼˜å…ˆçº§ä»»åŠ¡**ã€‚(PS: å¯ä»¥çœ‹åšæ–‡è§£æž)


### V1.0.7 2023.2.11

+ ä»»åŠ¡: äº‹ä»¶ç»„æ¨¡æ‹Ÿç«ç®­å‘å°„å€’è®¡æ—¶ç‚¹ç«
  > æ‰‹åŠ¨åˆ›å»ºäº‹ä»¶ç»„
  + Task1: å®žæ—¶æ£€æµ‹ç‚¹ç«
  + Task2: æ¨¡æ‹Ÿå€’è®¡æ—¶10ç§’
  + Task3: æŒ‰é”®ç¡®è®¤ç‚¹ç«
  + æˆåŠŸç‚¹ç«: å€’è®¡æ—¶å®Œæˆ + æŒ‰é”®ç¡®è®¤

+ å®žéªŒç»“æžœ
    ä»»åŠ¡2å€’æ•°10ç§’ï¼Œå½“ä»»åŠ¡3æŒ‰é”®æŒ‰ä¸‹åŽï¼Œä¸”å€’è®¡æ—¶1ç§’æ—¶ðŸš€å‘å°„ã€‚

+ è¡¥å……: äº‹ä»¶çš„é€»è¾‘æˆ–

```c
	  r_event = xEventGroupWaitBits(Event_Handle, /* äº‹ä»¶å¯¹è±¡å¥æŸ„ */
	  		  0x0001||0x0010,/* æŽ¥æ”¶çº¿ç¨‹æ„Ÿå…´è¶£çš„äº‹: äº‹ä»¶ç»„å¯„å­˜å™¨å€¼ */
	  		  pdTRUE, /* é€€å‡ºæ—¶æ¸…é™¤äº‹ä»¶ä½ */
	  		  pdTRUE, /* æ»¡è¶³æ„Ÿå…´è¶£çš„æ‰€æœ‰äº‹ä»¶ */
	  		  portMAX_DELAY);/* æŒ‡å®šè¶…æ—¶äº‹ä»¶,ä¸€ç›´ç­‰ */
```

### V1.0.8 2023.2.12

+ ä»»åŠ¡: ä»»åŠ¡é€šçŸ¥æ¨¡æ‹ŸäºŒå€¼ä¿¡å·é‡
  + Task1: æ¨¡æ‹ŸäºŒå€¼ä¿¡å·é‡ - æŽ¥æ”¶ä»»åŠ¡1
  + Task2: æ¨¡æ‹ŸäºŒå€¼ä¿¡å·é‡ - æŽ¥æ”¶ä»»åŠ¡2
  + Task3(ä»»åŠ¡ä¼˜å…ˆçº§æœ€ä½Ž): æ¨¡æ‹ŸæŒ‰é”®é‡Šæ”¾äºŒå€¼ä¿¡å·é‡: çŸ­æŒ‰æ¿€æ´»Task2ï¼Œé•¿æŒ‰æ¿€æ´»Task1

+ æ³¨æ„: è‹¥ä»»åŠ¡Task3ä¼˜å…ˆçº§ä¸ä½ŽäºŽ1ã€2ä¼šå¯¼è‡´å¼‚å¸¸ï¼ŒåŽŸå› æ˜¯ä¼šå…ˆè¿è¡Œé«˜ä¼˜å…ˆçº§ä»»åŠ¡

+ ç»“æžœ

```text
00:37:07:629 -> Receive2_Task Got!
00:37:07:631 -> 
00:37:07:632 -> Receive2_Task_Handle Send!
00:37:09:328 -> Program Running
00:37:09:971 -> Receive2_Task Got!
00:37:09:974 -> 
00:37:09:974 -> Receive2_Task_Handle Send!
00:37:11:464 -> Receive1_Task Got!
00:37:11:467 -> 
00:37:11:467 -> Receive1_Task_Handle Send!
00:37:14:329 -> Program Running
00:37:14:531 -> Receive1_Task Got!
00:37:14:533 -> 
00:37:14:533 -> Receive1_Task_Handle Send!
00:37:16:079 -> Receive1_Task Got!
00:37:16:083 -> 
00:37:16:083 -> Receive1_Task_Handle Send!
00:37:17:176 -> Receive2_Task Got!
00:37:17:179 -> 
00:37:17:179 -> Receive2_Task_Handle Send!
00:37:19:330 -> Program Running

```